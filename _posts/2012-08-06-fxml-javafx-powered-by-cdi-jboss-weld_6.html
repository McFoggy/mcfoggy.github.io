---
layout: post
title: FXML & JavaFX  powered by CDI & JBoss Weld
date: '2012-08-06T21:34:00.000+02:00'
author: Matthieu BROUILLARD
tags:
- java javafx cdi weld
modified_time: '2013-10-21T17:53:28.981+02:00'
blogger_id: tag:blogger.com,1999:blog-1656175910479000188.post-2487787283629277714
blogger_orig_url: http://blog.matthieu.brouillard.fr/2012/08/fxml-javafx-powered-by-cdi-jboss-weld_6.html
---

<span style="font-family: Verdana, sans-serif;">It has been for a while since I wanted to have CDI running with JavaFX2.</span><br /><span style="font-family: Verdana, sans-serif;">Some people already blogged on how to proceed to have <a href="http://andrewtill.blogspot.be/2012/07/creating-javafx-controllers-using-guice.html">Guice injection</a> [1] working with JavaFX &amp; FXML.</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;">Now it's my turn to provide a way to empower JavaFX with CDI using Weld as the implementation.</span><br /><span style="font-family: Verdana, sans-serif;">My goal was to have CDI just working, no matter how I was using JavaFX by directly coding in plain Java or using FXML.</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;">Ready? let's go !!!</span><br /><h3><span style="font-family: Verdana, sans-serif;">Bootstrap JavaFX &amp; Weld/CDI</span></h3><span style="font-family: Verdana, sans-serif;">The launcher class will be the only place where we will have Weld specific code, all the rest will be totally CDI compliant.</span><br /><span style="font-family: Verdana, sans-serif;">The only trick here is to make the application parameters available as a CDI compliant object so that we can reuse them afterwards.</span><br /><span style="font-family: Verdana, sans-serif;">Notice also that we use the CDI event mechanism to startup our real application code.</span><br /><span style="font-family: Verdana, sans-serif;"><br /></span><br /><pre class="brush: java">public class WeldJavaFXLauncher extends Application {<br />  /**<br />  * Nothing special, we just use the JavaFX Application methods to boostrap<br />  * JavaFX<br />  */<br />  public static void main(String[] args) {<br />    Application.launch(WeldJavaFXLauncher.class, args);<br />  }<br /><br />  @SuppressWarnings("serial")<br />  @Override<br />  public void start(final Stage primaryStage) throws Exception {<br />    // Let's initialize CDI/Weld.<br />    WeldContainer weldContainer = new Weld().initialize();<br />    // Make the application parameters injectable with a standard CDI<br />    // annotation<br />    weldContainer.instance().select(ApplicationParametersProvider.class).get().setParameters(getParameters());<br />    // Now that JavaFX thread is ready<br />    // let's inform whoever cares using standard CDI notification mechanism:<br />    // CDI events<br />    weldContainer.event().select(Stage.class, new AnnotationLiteral&lt;StartupScene&gt;() {}).fire(primaryStage);<br />  }<br />}</pre><br /><h3><span style="font-family: Verdana, sans-serif;">Start our real JavaFX application</span></h3><span style="font-family: Verdana, sans-serif;">Here starts our real application code. We're just listening the previously fired event (containing the Scene object to render into) and start showing our application.</span><br /><span style="font-family: Verdana, sans-serif;">In the following example, we load an FXML GUI but it might have been any node created in any way.</span><br /><br /><pre class="brush: java">public class LoginApplicationStarter {<br />  // Let's have a FXMLLoader injected automatically<br /> @Inject FXMLLoader fxmlLoader;<br /><br />  // Our CDI entry point, we just listen to an event providing the startup scene<br /> public void launchJavaFXApplication(@Observes @StartupScene Stage s) {<br />  InputStream is = null;<br /><br />  try {<br />   is = getClass().getResourceAsStream("login.fxml");<br />   // we just load our FXML form (including controler and so on)<br />   Parent root = (Parent) fxmlLoader.load(is);<br />   s.setScene(new Scene(root, 300, 275));<br />   s.show(); // let's show the scene<br />  } catch (IOException e) {<br />   throw new IllegalStateException("cannot load FXML login screen", e);<br />  } finally {<br />      // omitted is cleanup<br />  }<br /> }<br />}</pre><br /><h3><span style="font-family: Verdana, sans-serif;">But what about the FXML controller?</span></h3><div style="font-family: Verdana,sans-serif;">First let's have a look at the controller we want to use inside our application.<br />It is a pure POJO class annoted with both JavaFX &amp; CDI annotations.</div><pre class="brush: java">// Simple application controller that uses injected fields <br />// to delegate login process and to get default values from the command line using: --user=SomeUser<br />public class LoginController implements Initializable {<br />    // Standard FXML injected fields<br /> @FXML TextField loginField;<br /> @FXML PasswordField passwordField;<br /> @FXML Text feedback;<br /> <br /> // CDI Injected service<br /> @Inject LoginService loginService;<br /> <br />    // Default application parameters retrieved using CDI<br /> @Inject Parameters applicationParameters;<br /> <br /> @FXML protected void handleSubmitButtonAction(ActionEvent event) {<br />  feedback.setText(loginService.login(loginField.getText(), passwordField.getText()));<br /> }<br /><br /> @Override<br /> public void initialize(URL location, ResourceBundle resources) {<br />  loginField.setText(applicationParameters.getNamed().get("user"));<br /> }<br />}<br /></pre><span style="font-family: Verdana, sans-serif;">In order to have injection working inside the FXML controller we need to intrument JavaFX so that controller objects are created by CDI.</span><br /><span style="font-family: Verdana, sans-serif;">As we are in a CDI environment we can also have the FXMLLoader classes injected, that's exactly what we did in the previous LoginApplicationStarter class.</span><br /><span style="font-family: Verdana, sans-serif;">How can we achieve this?&nbsp;</span><br /><span style="font-family: Verdana, sans-serif;">We just have to provide a Producer class which responsibility will be to create FXMLLoader instances able to load FXML GUIs and instanciate controllers using CDI.</span><br /><span style="font-family: Verdana, sans-serif;">The only thing a little bit tricky there is that the controller instanciation depends on the required class or interface (using fx:controller in your fxml file). In order to have such a runtime injection/resolution available we use a</span><br /><span style="font-family: Verdana, sans-serif;">CDI Instance Object.</span><br /><br /><pre class="brush: java">public class FXMLLoaderProducer {<br /> @Inject Instance&lt;Object&gt; instance;<br /> <br /> @Produces<br /> public FXMLLoader createLoader() {<br />  FXMLLoader loader = new FXMLLoader();<br />  loader.setControllerFactory(new Callback&lt;Class&lt;?&gt;, Object&gt;() {<br />   @Override<br />   public Object call(Class&lt;?&gt; param) {<br />    return instance.select(param).get();<br />   }<br />  });<br />  return loader;<br /> }<br />}</pre><span style="font-family: Verdana, sans-serif;"><br /></span><span style="font-family: Verdana, sans-serif;">I hope you found the article interesting and of course&nbsp;do not hesitate to comment if you see some errors or possible enhancements...</span><br /><br /><span style="font-family: Verdana, sans-serif;">Finally if you are interrested you can find the full source code <a href="https://docs.google.com/open?id=0B1iv-9EBkpq7U2VrY2k2SkNrZjg">here</a>. </span><br /><br /><span style="font-family: Verdana, sans-serif;">[1] <a href="http://andrewtill.blogspot.be/2012/07/creating-javafx-controllers-using-guice.html">http://andrewtill.blogspot.be/2012/07/creating-javafx-controllers-using-guice.htm</a></span>